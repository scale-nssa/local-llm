# Minimal Cross-Language Packaging Plan

Goal: Provide the simplest path for teammates to install and use the project from GitHub in BOTH Python and R without publishing to PyPI or CRAN. Keep scope minimal: only what is necessary to:
- Install a Python package via `pip install git+https://...#subdirectory=python`
- Install an R package via `remotes::install_github(..., subdir="Rpkg")`
- Generate / provide config files or helpers
- Run local llama-server and call `get_response`

Scope explicitly NOT included (for now):
- PyPI / CRAN release
- CI automation & version synchronization
- Docker image
- Simple index / drat repo
- Streaming APIs / advanced features

---
## 1. Repository Restructure (Lightweight)

1. Keep existing root layout; add an `Rpkg/` directory for the R package skeleton.
2. Move (or copy initially) `R/utils.R`, `R/start_server.R`, other R scripts into `Rpkg/R/`.
3. Keep existing Python code under `python/` but migrate to a `src/` layout for clarity.

Resulting minimal layout (only new/changed parts shown):
```
local-llm/
  python/
    pyproject.toml
    src/
      local_llm/
        __init__.py
        client.py        # from utils.py (get_response, grammar loader)
        grammar.py       # multiple_choice_grammar, grammar
        server.py        # refactored start_server logic as functions (optional for now)
  Rpkg/
    DESCRIPTION
    NAMESPACE (generated by roxygen2 later or minimal manual)
    R/
      client.R          # get_response
      grammar.R         # grammar + multiple_choice_grammar
      server.R          # start_server logic
      config.R          # default_server_config, write_server_config (optional minimal)
    README.Rmd (optional later)
```

---
## 2. Python Minimal Packaging Steps

1. Create `python/src/local_llm/__init__.py` with version and simple re-exports:
   ```python
   __all__ = ["get_response", "grammar", "multiple_choice_grammar"]
   from .client import get_response, grammar
   from .grammar import multiple_choice_grammar
   __version__ = "0.1.0"
   ```
2. Split `utils.py` into `client.py` and `grammar.py` OR keep as single `client.py` initially (simpler). If keeping single file, rename `utils.py` -> `client.py` and adjust imports.
3. Update `pyproject.toml` to use src layout if changed:
   - Add `packages = ["local_llm"]` depending on backend (or rely on auto-discovery with setuptools if used).
4. Ensure no relative filesystem dependencies (grammar files loaded via path user supplies).
5. Provide quick usage example in root `README.md`:
   ```bash
   pip install "git+https://github.com/ORG/local-llm@v0.1.0#subdirectory=python"
   python -c "from local_llm import get_response; print(get_response('Hello', model='local'))"
   ```

Optional (can defer): create `server.py` module factoring out logic from `start_server.py`. For the minimal plan we can leave `start_server.py` as a script not installed (users run it from repo clone only) OR include a lightweight wrapper later.

---
## 3. R Minimal Packaging Steps

1. Create `Rpkg/DESCRIPTION`:
   ```
   Package: localllm
   Type: Package
   Title: Local LLaMA Helpers
   Version: 0.1.0
   Authors@R: person(given="First", family="Last", role=c("aut","cre"), email="you@example.com")
   Description: Minimal helpers to interact with a local llama-server over its OpenAI-compatible API plus simple grammar utilities.
   License: MIT + file LICENSE
   Encoding: UTF-8
   Depends: R (>= 4.2)
   Imports: httr2, jsonlite, yaml, processx
   Suggests: testthat (>= 3.1.0)
   Config/testthat/edition: 3
   ```
2. Copy logic from `R/utils.R` into two files:
   - `R/client.R`: `get_response`, `grammar`
   - `R/grammar.R`: `multiple_choice_grammar`
3. Copy logic from `R/start_server.R` to `R/server.R` and rename exported function to `start_server` (remove shebang). Keep the existing implementation with minimal editsâ€”only remove direct script execution guard if needed.
4. (Optional but helpful) Add `R/config.R` with:
   ```r
   default_server_config <- function() list(model_path="<REPLACE_ME>", n_ctx=4096, n_gpu_layers=50, port=8080)
   write_server_config <- function(path="server.yaml", ..., overwrite=FALSE) {
     if (file.exists(path) && !overwrite) stop("File exists: ", path)
     cfg <- modifyList(default_server_config(), list(...))
     yaml::write_yaml(cfg, path)
     invisible(path)
   }
   ```
5. Create a minimal `NAMESPACE` (temporary) listing exports:
   ```
   export(get_response)
   export(grammar)
   export(multiple_choice_grammar)
   export(start_server)
   export(default_server_config)
   export(write_server_config)
   ```
6. Install test (optional minimal smoke test) can be deferred.
7. Usage example for README:
   ```r
   remotes::install_github("ORG/local-llm", subdir="Rpkg")
   localllm::get_response("Hello", model="local")
   ```

---
## 4. Config Handling (Minimal)

Decision: Do NOT package YAML templates initially.
Provide helpers (R optional, Python can rely on user-created YAML). Document a sample config in README:
```yaml
# server.yaml
model_path: /path/to/model.gguf
n_ctx: 4096
n_gpu_layers: 50
port: 8080
```
Explain invocation:
- Python script workflow: clone repo and run `python/start_server.py` OR (future) after packaging, expose a function.
- R: `localllm::start_server("server.yaml")`.

---
## 5. Manual Release / Install Instructions

Versioning: Set both Python `__version__` and R `DESCRIPTION` Version to the same manually.

Tag release:
```
git tag -a v0.1.0 -m "Initial minimal dual-language release"
git push origin v0.1.0
```

Install (Python):
```
pip install "git+https://github.com/ORG/local-llm@v0.1.0#subdirectory=python"
```
Install (R):
```r
remotes::install_github("ORG/local-llm", ref="v0.1.0", subdir="Rpkg")
```

---
## 6. Minimal Acceptance Criteria

- Python import works: `from local_llm import get_response` (function executes against running server or fails gracefully if server unreachable).
- R package loads: `library(localllm)`; exported functions are present.
- Grammar generation available in both languages.
- README documents install + config + basic usage for both ecosystems.

---
## 7. Deferred (Future Enhancements)
(Listed but intentionally out of initial scope)
- CLI entry points (Python console_scripts)
- Config auto-generation helpers for Python
- Better error handling / structured exceptions
- Unit tests & CI workflows
- Version sync script & CHANGELOG
- Grammar templates packaged as data
- Simple index / drat style repositories
- Docker image bundling both environments

---
## 8. Task Breakdown (Impl Order)

1. Create `Rpkg/` skeleton (DESCRIPTION, NAMESPACE, R/ files).
2. Restructure Python into `src/local_llm` (or minimally add `__init__.py`).
3. Move/split Python functions (optional simplification: keep single module first).
4. Copy/refactor R scripts into package functions.
5. Update root README with dual-language install instructions + sample config.
6. Bump versions to `0.1.0` in both places.
7. Git tag & push.

Done.

---
## 9. Quick Rollback Strategy
Changes are additive; if issues arise, users can still clone and run original scripts. Keep original R scripts until confident, then remove after verifying install path works.

---
## 10. Success Signal
Teammate (Python user) installs via pip URL and successfully calls:
```python
from local_llm import multiple_choice_grammar
print(multiple_choice_grammar(["yes","no"], "./grammars", "bool", thinking=False)[:80])
```
Teammate (R user) installs via remotes and runs:
```r
localllm::multiple_choice_grammar(c("yes","no"), "grammars", "bool", thinking=FALSE)
```
Both produce expected grammar file & content.

---
(End of minimal plan)
